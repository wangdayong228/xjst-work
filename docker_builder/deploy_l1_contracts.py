#!/usr/bin/env python3
"""
Deploy L1 contracts (simple_calculator / state_sender / unified_bridge) using web3.

- Bytecodes are read directly from the Rust contract_manager sources to stay in sync.
- Uses the default L1 admin private key as the default deployer; override via CLI.
- Waits for each deployment transaction to be mined and prints the contract address.
"""
import argparse
import json
import os
import sys
from pathlib import Path
from typing import Dict, List, Optional, Tuple

try:
    from web3 import Web3, HTTPProvider
    from web3.providers.websocket import WebsocketProvider
    from eth_account import Account
except ImportError as exc:
    print(f"web3/eth_account not installed: {exc}")
    sys.exit(1)

# Defaults from configuration.rs
DEFAULT_L1_ADMIN_PRIVATE_KEY = (
    "148ab921959d9064168f84e801729806612d7ec1685f6dd5ea1fb3940b69a001"
)
DEFAULT_RPC_URL = "ws://confura.yidaiyilu0.site/ws"
# If not provided, will auto-detect from RPC
DEFAULT_CHAIN_ID = None

# Bytecode constants (copied from Rust sources). Replace with your own if needed.
L1_SIMPLE_CALCULATOR_BYTECODE = (
    "0x608060405234801561001057600080fd5b5060008081905550610644806100276000396000f3fe608060405234801561001057600080fd5b506004361061007d5760003560e01c80633e823f791161005b5780633e823f7914610124578063698996f814610166578063c6888fa114610184578063d826f88f146101c65761007d565b80631003e2d2146100825780631dc05f17146100c45780632096525514610106575b600080fd5b6100ae6004803603602081101561009857600080fd5b81019080803590602001909291905050506101e4565b6040518082815260200191505060405180910390f35b6100f0600480360360208110156100da57600080fd5b8101908080359060200190929190505050610280565b6040518082815260200191505060405180910390f35b61010e610377565b6040518082815260200191505060405180910390f35b6101506004803603602081101561013a57600080fd5b8101908080359060200190929190505050610380565b6040518082815260200191505060405180910390f35b61016e61047c565b6040518082815260200191505060405180910390f35b6101b06004803603602081101561019a57600080fd5b8101908080359060200190929190505050610482565b6040518082815260200191505060405180910390f35b6101ce61051e565b6040518082815260200191505060405180910390f35b60008060005490508260008082825401925050819055507f9cbe280b38c6b967277303bd6222a78b75e25f5b7036b3bfc033cad7df50b988816000546040518083815260200182815260200180602001828103825260038152602001807f6164640000000000000000000000000000000000000000000000000000000000815250602001935050505060405180910390a1600054915050919050565b60008060005490508260005410156102e3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603c8152602001806105b1603c913960400191505060405180910390fd5b8260008082825403925050819055507f9cbe280b38c6b967277303bd6222a78b75e25f5b7036b3bfc033cad7df50b988816000546040518083815260200182815260200180602001828103825260088152602001807f7375627472616374000000000000000000000000000000000000000000000000815250602001935050505060405180910390a1600054915050919050565b60008054905090565b6000806000549050600083116103e1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001806105ed6022913960400191505060405180910390fd5b82600080828254816103ef57fe5b04925050819055507f9cbe280b38c6b967277303bd6222a78b75e25f5b7036b3bfc033cad7df50b988816000546040518083815260200182815260200180602001828103825260068152602001807f6469766964650000000000000000000000000000000000000000000000000000815250602001935050505060405180910390a1600054915050919050565b60005481565b60008060005490508260008082825402925050819055507f9cbe280b38c6b967277303bd6222a78b75e25f5b7036b3bfc033cad7df50b988816000546040518083815260200182815260200180602001828103825260088152602001807f6d756c7469706c79000000000000000000000000000000000000000000000000815250602001935050505060405180910390a1600054915050919050565b6000806000549050600080819055507f9cbe280b38c6b967277303bd6222a78b75e25f5b7036b3bfc033cad7df50b988816000546040518083815260200182815260200180602001828103825260058152602001807f7265736574000000000000000000000000000000000000000000000000000000815250602001935050505060405180910390a16000549150509056fe53696d706c6543616c63756c61746f723a207375627472616374696f6e20776f756c6420726573756c7420696e206e656761746976652076616c756553696d706c6543616c63756c61746f723a206469766973696f6e206279207a65726fa2646970667358221220bd39209ffbbc195231d66ebadd2162c42623f5873762757a150c3b54c76fbbc764736f6c63430006000033"
)
L1_STATE_SENDER_BYTECODE = (
    "0x608060405234801561001057600080fd5b5060006100216100c460201b60201c565b9050806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508073ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3506100cc565b600033905090565b6111ad806100db6000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c80638f32d59b116100665780638f32d59b1461018d578063942e6bcf146101ad5780639a527e871461021b578063aa677354146102b4578063f2fde38b1461031857610093565b806316f198311461009857806361bc221a14610131578063715018a61461014f5780638da5cb5b14610159575b600080fd5b61012f600480360360408110156100ae57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001906401000000008111156100eb57600080fd5b8201836020820111156100fd57600080fd5b8035906020019184600183028401116401000000008311171561011f57600080fd5b909192939192939050505061035c565b005b6101396106b9565b6040518082815260200191505060405180910390f35b6101576106bf565b005b6101616107f7565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b610195610820565b60405180821515815260200191505060405180910390f35b6101ef600480360360208110156101c357600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061087e565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6102b26004803603604081101561023157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019064010000000081111561026e57600080fd5b82018360208201111561028057600080fd5b803590602001918460018302840111640100000000831117156102a257600080fd5b90919293919293905050506108b1565b005b610316600480360360408110156102ca57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061094e565b005b61035a6004803603602081101561032e57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610c3e565b005b8260006103c7600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16610cc4565b905060006103d433610cc4565b90503373ffffffffffffffffffffffffffffffffffffffff16600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614828260405160200180807f496e76616c69642053656e6465722c2045786570743a2000000000000000000081525060170183805190602001908083835b602083106104c457805182526020820191506020810190506020830392506104a1565b6001836020036101000a038019825116818451168082178552505050505050905001807f2043757272656e743a2000000000000000000000000000000000000000000000815250600a0182805190602001908083835b6020831061053d578051825260208201915060208101905060208303925061051a565b6001836020036101000a0380198251168184511680821785525050505050509050019250505060405160208183030381529060405290610618576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825283818151815260200191508051906020019080838360005b838110156105dd5780820151818401526020810190506105c2565b50505050905090810190601f16801561060a5780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5061062e60018054610f4e90919063ffffffff16565b6001819055508573ffffffffffffffffffffffffffffffffffffffff166001547f103fed9db65eac19c4d870f49ab7520fe03b99f1838e5996caf47e9e43308392878760405180806020018281038252848482818152602001925080828437600081840152601f19601f820116905080830192505050935050505060405180910390a3505050505050565b60015481565b6106c7610820565b610739576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a360008060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16610862610fd6565b73ffffffffffffffffffffffffffffffffffffffff1614905090565b60026020528060005260406000206000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6108c660018054610f4e90919063ffffffff16565b6001819055508273ffffffffffffffffffffffffffffffffffffffff166001547f103fed9db65eac19c4d870f49ab7520fe03b99f1838e5996caf47e9e43308392848460405180806020018281038252848482818152602001925080828437600081840152601f19601f820116905080830192505050935050505060405180910390a3505050565b610956610820565b806109eb57503373ffffffffffffffffffffffffffffffffffffffff16600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b610a40576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260308152602001806111486030913960400191505060405180910390fd5b81600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600073ffffffffffffffffffffffffffffffffffffffff16600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610bc8578073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f3f4512aacd7a664fdb321a48e8340120d63253a91c6367a143abd19ecf68aedd60405160405180910390a4610c3a565b8073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fc51cb1a93ec91e927852b3445875ec77b148271953e5c0b43698c968ad6fc47d60405160405180910390a45b5050565b610c46610820565b610cb8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b610cc181610fde565b50565b606060006040518060400160405280601081526020017f303132333435363738396162636465660000000000000000000000000000000081525090506000602a67ffffffffffffffff81118015610d1a57600080fd5b506040519080825280601f01601f191660200182016040528015610d4d5781602001600182028036833780820191505090505b5090507f300000000000000000000000000000000000000000000000000000000000000081600081518110610d7e57fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053507f780000000000000000000000000000000000000000000000000000000000000081600181518110610ddb57fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535060005b6014811015610f43578260106002830260270360100a8773ffffffffffffffffffffffffffffffffffffffff1681610e4157fe5b0460ff1681610e4c57fe5b0660ff1681518110610e5a57fe5b602001015160f81c60f81b826002830260020181518110610e7757fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508260106002830260260360100a8773ffffffffffffffffffffffffffffffffffffffff1681610ed157fe5b0460ff1681610edc57fe5b0660ff1681518110610eea57fe5b602001015160f81c60f81b826002830260030181518110610f0757fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080600101915050610e0d565b508092505050919050565b600080828401905083811015610fcc576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f536166654d6174683a206164646974696f6e206f766572666c6f77000000000081525060200191505060405180910390fd5b8091505092915050565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415611064576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001806111226026913960400191505060405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a3806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505056fe4f776e61626c653a206e6577206f776e657220697320746865207a65726f2061646472657373537461746553656e6465722e72656769737465723a204e6f7420617574686f72697a656420746f207265676973746572a26469706673582212202689172c3e18aa7c1e0ebe530f3cab35f64cbd27c416dac03a565555b3cdbc5c64736f6c63430007060033"
)
L1_UNIFIED_BRIDGE_BYTECODE = (
    "0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610bdc806100606000396000f3fe608060405234801561001057600080fd5b506004361061009e5760003560e01c80632f764644116100665780632f764644146101c1578063590e1577146102055780638f28397014610247578063ae34b4701461028b578063f851a440146103385761009e565b806308ce7c73146100a357806319cdb66e146100d157806324c694f11461011d5780632dbe6821146101615780632ec2e36e1461017f575b600080fd5b6100cf600480360360208110156100b957600080fd5b810190808035906020019092919050505061036c565b005b610107600480360360408110156100e757600080fd5b810190808035906020019092919080359060200190929190505050610474565b6040518082815260200191505060405180910390f35b6101496004803603602081101561013357600080fd5b810190808035906020019092919050505061051b565b60405180821515815260200191505060405180910390f35b610169610545565b6040518082815260200191505060405180910390f35b6101ab6004803603602081101561019557600080fd5b810190808035906020019092919050505061054b565b6040518082815260200191505060405180910390f35b6101ed600480360360208110156101d757600080fd5b810190808035906020019092919050505061056e565b60405180821515815260200191505060405180910390f35b6102316004803603602081101561021b57600080fd5b810190808035906020019092919050505061058e565b6040518082815260200191505060405180910390f35b6102896004803603602081101561025d57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506105ac565b005b610336600480360360808110156102a157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001906401000000008111156102de57600080fd5b8201836020820111156102f057600080fd5b8035906020019184600183028401116401000000008311171561031257600080fd5b90919293919293908035906020019092919080359060200190929190505050610793565b005b610340610a87565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610410576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180610b0d6026913960400191505060405180910390fd5b600154811161046a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526032815260200180610adb6032913960400191505060405180910390fd5b8060018190555050565b6000600260008481526020019081526020016000206001018054905082106104e7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526022815260200180610b596022913960400191505060405180910390fd5b60026000848152602001908152602001600020600101828154811061050857fe5b9060005260206000200154905092915050565b60006003600083815260200190815260200160002060009054906101000a900460ff169050919050565b60015481565b600060026000838152602001908152602001600020600101805490509050919050565b60036020528060005260406000206000915054906101000a900460ff1681565b60026020528060005260406000206000915090508060000154905081565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610650576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180610b0d6026913960400191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614156106d6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602f815260200180610aac602f913960400191505060405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff1660008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f7e644d79422f17c01e4894b5f4f588d331ebfa28653d42ae832dc59e38c9798f60405160405180910390a3806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610837576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180610b0d6026913960400191505060405180910390fd5b6003600082815260200190815260200160002060009054906101000a900460ff16156108ae576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602c815260200180610b7b602c913960400191505060405180910390fd5b60008573ffffffffffffffffffffffffffffffffffffffff1685856040518083838082843780830192505050925050506000604051808303816000865af19150503d806000811461091b576040519150601f19603f3d011682016040523d82523d6000602084013e610920565b606091505b505090508061097a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180610b336026913960400191505060405180910390fd5b60016003600084815260200190815260200160002060006101000a81548160ff0219169083151502179055506000600260008581526020019081526020016000206000015414156109e1578260026000858152602001908152602001600020600001819055505b60026000848152602001908152602001600020600101829080600181540180825580915050600190039060005260206000200160009091909190915055600154831115610a3057826001819055505b81837f3f7d2fca5eece421fe5c665e373d19ff626bd0e67c64221dd5ba4b96f78c116888604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a3505050505050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff168156fe556e69666965644272696467653a206e65772061646d696e2063616e6e6f74206265207a65726f2061646472657373556e69666965644272696467653a206e6577204944206d7573742062652067726561746572207468616e2063757272656e74556e69666965644272696467653a2063616c6c6572206973206e6f74207468652061646d696e556e69666965644272696467653a2063726f737320636861696e2063616c6c206661696c6564556e69666965644272696467653a20696e646578206f7574206f6620626f756e6473556e69666965644272696467653a207472616e73616374696f6e20616c72656164792070726f636573736564a2646970667358221220430f0843984a4ed7496ea2063db3f4247579599f9ce081c2ccff1fb1164d1b0264736f6c63430007060033"
)


def make_web3(rpc_url: str) -> Web3:
    if rpc_url.startswith("ws"):
        provider = WebsocketProvider(rpc_url)
    else:
        provider = HTTPProvider(rpc_url)
    w3 = Web3(provider)
    is_connected = (
        w3.is_connected() if hasattr(w3, "is_connected") else w3.isConnected()
    )
    if not is_connected:
        raise RuntimeError(f"Cannot connect to RPC endpoint: {rpc_url}")
    return w3


def deploy_contract(
    w3: Web3, account, bytecode: str, nonce: int, chain_id: int, gas_price: int = None
) -> Tuple[str, str]:
    tx: Dict = {
        "from": account.address,
        "value": 0,
        "data": bytecode,
        "nonce": nonce,
        "chainId": chain_id,
    }
    tx["gasPrice"] = gas_price if gas_price is not None else w3.eth.gas_price
    tx["gas"] = w3.eth.estimate_gas(tx)

    signed = account.sign_transaction(tx)
    tx_hash = w3.eth.send_raw_transaction(signed.rawTransaction)
    receipt = w3.eth.wait_for_transaction_receipt(
        tx_hash, timeout=600, poll_latency=3
    )

    status = receipt.get("status", 0)
    if status != 1:
        raise RuntimeError(f"Deployment failed, tx={tx_hash.hex()}, receipt={receipt}")

    contract_address = receipt.get("contractAddress")
    if not contract_address:
        raise RuntimeError(f"No contract address in receipt for tx {tx_hash.hex()}")

    return tx_hash.hex(), Web3.to_checksum_address(contract_address)


def save_contracts_to_json(
    chain_id: int,
    rpc_url: str,
    deployer: str,
    deployments: List[Tuple[str, str, str]],
    output_path: Optional[Path] = None,
) -> None:
    """将部署的合约地址保存到 JSON 文件。

    Args:
        chain_id: 链 ID
        rpc_url: RPC 端点 URL
        deployer: 部署者地址
        deployments: 部署结果列表，每个元素为 (name, tx_hash, address)
        output_path: 输出文件路径，如果为 None 则使用默认路径 ../output/contracts.json
    """
    try:
        # 构建输出数据结构
        output_data = {
            "chain_id": chain_id,
            "rpc_url": rpc_url,
            "deployer": deployer,
        }
        # 将合约名称作为键，地址作为值添加到顶层
        for name, tx_hash, addr in deployments:
            output_data[name] = addr

        # 计算输出文件路径（相对于脚本文件位置）
        if output_path is None:
            script_dir = Path(__file__).parent
            output_dir = script_dir.parent / "output"
            output_path = output_dir / "contracts.json"

        # 确保输出目录存在
        output_path.parent.mkdir(parents=True, exist_ok=True)

        # 写入 JSON 文件
        with open(output_path, "w", encoding="utf-8") as f:
            json.dump(output_data, f, indent=2, ensure_ascii=False)

        print(f"\n✅ 合约地址已写入: {output_path}")
    except Exception as e:
        print(f"\n⚠️  写入 JSON 文件失败: {e}")


def main():
    parser = argparse.ArgumentParser(
        description="Deploy L1 bridge-related contracts to eSpace."
    )
    parser.add_argument(
        "--rpc-url",
        default=DEFAULT_RPC_URL,
        help="RPC endpoint for L1 eSpace (http(s):// or ws(s)://)",
    )
    parser.add_argument(
        "--chain-id",
        type=int,
        default=DEFAULT_CHAIN_ID,
        help="Chain ID for signing transactions (default: auto-detect from RPC)",
    )
    parser.add_argument(
        "--private-key",
        default=DEFAULT_L1_ADMIN_PRIVATE_KEY,
        help="Deployer private key (hex, no 0x prefix)",
    )
    parser.add_argument(
        "--gas-price",
        type=int,
        default=None,
        help="Optional fixed gas price (wei). Default: fetch from node",
    )

    args = parser.parse_args()

    bytecodes = {
        "simple_calculator": L1_SIMPLE_CALCULATOR_BYTECODE,
        "state_sender": L1_STATE_SENDER_BYTECODE,
        "unified_bridge": L1_UNIFIED_BRIDGE_BYTECODE,
    }

    w3 = make_web3(args.rpc_url)
    account = Account.from_key(args.private_key)

    detected_chain_id = w3.eth.chain_id
    chain_id = args.chain_id if args.chain_id is not None else detected_chain_id

    if args.chain_id is not None and args.chain_id != detected_chain_id:
        raise RuntimeError(
            f"Provided chain_id ({args.chain_id}) mismatches node chain_id ({detected_chain_id}). "
            f"Please re-run with --chain-id={detected_chain_id} or correct RPC."
        )

    print(f"Connected to {args.rpc_url}, chain_id={chain_id} (node={detected_chain_id})")
    print(f"Deployer: {account.address}")

    current_nonce = w3.eth.get_transaction_count(account.address)

    deployments = []
    for name in ["state_sender", "unified_bridge", "simple_calculator"]:
        print(f"Deploying {name} ...")
        tx_hash, contract_address = deploy_contract(
            w3,
            account,
            bytecodes[name],
            current_nonce,
            chain_id,
            gas_price=args.gas_price,
        )
        print(f"  tx: {tx_hash}")
        print(f"  contract: {contract_address}")
        deployments.append((name, tx_hash, contract_address))
        current_nonce += 1

    print("\nDeployment summary:")
    for name, tx_hash, addr in deployments:
        print(f"- {name}: {addr} (tx {tx_hash})")

    # 输出到 JSON 文件
    save_contracts_to_json(
        chain_id=chain_id,
        rpc_url=args.rpc_url,
        deployer=account.address,
        deployments=deployments,
    )


if __name__ == "__main__":
    main()